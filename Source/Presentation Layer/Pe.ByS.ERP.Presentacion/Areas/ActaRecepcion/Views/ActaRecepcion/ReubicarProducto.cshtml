@{
    ViewBag.Title = "ReubicarProducto";
    Layout = "~/Views/Shared/_LayoutI.cshtml";
}

<div class="form-horizontal">
    <div class="row">
        <div class="col-md-12">
            <div class="text-center" style="padding-bottom: 20px;">
                <h2>Registrar Almacenamiento de Artículo</h2>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-7">
            <div class="form-group form-group-sm">
                <label class="control-label col-md-4 col-sm-4 col-xs-12">Número de Acta de Recepción:</label>
                <div class="col-sm-8 col-sm-8 col-xs-12">
                    @Html.TextBox("txtNumeroActa", "", new {@class = "form-control"})
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <button type="button" class="btn btn-success" id="btnBuscar">
                <i class="fa fa-search"></i>
                Buscar
            </button>
            @*<button type="button" class="btn btn-info" id="btnReubicar">
                <i class="fa fa-search"></i>
                Reubicar Stock
            </button>*@
        </div>
    </div>
    <div class="row" style="padding-bottom: 20px;"></div>
</div>

<div>
    <input id="hfIdentDetalle" type="hidden"/>
    <table style="width: 100%" id="tablaDetalle"></table>
    <div style="width: 100%" id="barraDetalle"></div>
</div>

<div class="form-horizontal">
    <div class="row" style="padding-bottom: 20px;"></div>
    <div class="box-footer">
        <div class="col-md-offset-3 col-md-9">
            <button type="button" class="btn btn-info" id="btnRegistrar">
                <i class="fa fa-floppy-o"></i>
                Registrar
            </button>
        </div>
    </div>
</div>

<script type="text/javascript">
    var grdDetalle = 'tablaDetalle';

    $(document).ready(function () {
        ListarActaDetalle();
    });

    function ListarActaDetalle() {
        var colNames = [
            'AlmacenId', 'Almacén', 'Código', 'Articulo', 'Unidad', 'Lote', 'Cant. Rec.', 'Módulo', 'Columna', 'Fila'
        ];
        var colModels = [
            { name: 'AlmacenId', index: 'AlmacenId', hidden: true },
            { name: 'AlmacenNombre', index: 'AlmacenNombre', align: 'center', width: 150 },
            { name: 'ProductoId', index: 'ProductoId', align: 'center', width: 60 },
            { name: 'ProductoNombre', index: 'ProductoNombre', align: 'left', width: 150 },
            { name: 'UnidadMedida', index: 'UnidadMedida', align: 'center', width: 60 },
            { name: 'Lote', index: 'Lote', align: 'center', width: 60 },
            { name: 'CantidadRecepcionada', index: 'CantidadRecepcionada', align: 'right', width: 60 },
            { name: 'Modulo', index: 'Modulo', align: 'center', width: 60, editable: true },
            { name: 'Columna', index: 'Columna', align: 'center', width: 60, editable: true, editrules: { custom: true, custom_func: validarNumero } },
            { name: 'Fila', index: 'Fila', align: 'center', width: 60, editable: true, editrules: { custom: true, custom_func: validarNumero } }
        ];

        var opciones = {
            gridLocal: true,
            nuevo: false,
            editar: false,
            eliminar: false,
            search: false,
            refresh: false,
            nuevoCaption: 'Agregar',
            editarCaption: 'Editar',
            eliminarCaption: 'Eliminar',
            dialogDelete: 'dialog-DetalleEliminar',
            mensaje: 'Seleccione un registro',
            sinRegistro: 'Sin registro',
            alertTitle: 'Alerta',
            caption: 'Productos a ubicar',
            grilla: grdDetalle,
            pager: 'barraDetalle',
            height: 180,
            width: 'auto',
            id: 'id',
            colsNames: colNames,
            colsModel: colModels,
            sortName: 'Id',
            pgbuttons: false,
            rowNumbers: [],
            viewrecords: false,
            pginput: false,
            EditingOptions: {
                canEditRowInline: true,
                editUrl: 'clientArray'
                //AfterSaveFunc: afterSaveDetalle
            }
        };

        SIG.GrillaUpgrade(opciones);
    }

    $("#btnBuscar").click(function () {
        var numActa = $("#txtNumeroActa").val();
        if (numActa !== "")
            cargarDetalleActa(numActa);
    });

    $("#btnReubicar").click(function () {
        alert('No se detalla la funcion de este boton en el documento');
    });

    $("#btnRegistrar").click(function() {
        var model = {
            detalleUbicacion: $("#" + grdDetalle).jqGrid('getGridParam', 'data')
        };

        var item, msj = "";

        if (model.detalleUbicacion.length === 0)
            msj += "- Busque un número de acta de recepción.";
        else {
            for (var i = 0; i < model.detalleUbicacion.length; i++) {
                item = model.detalleUbicacion[i];
                if (!item.Modulo || !item.Columna || !item.Columna) {
                    msj += "- Ingrese el módulo, columna y fila de los productos a ubicar.";
                    break;
                }
            }
        }

        if (msj !== "") {
            SIG.Alert('Alerta', msj, null);
            return;
        }

        var opciones = {
            url: '@Url.Action("GuardarUbicacion", "ActaRecepcion", new { area = "ActaRecepcion" })',
            parametros: model
        };

        SIG.Ajax(opciones, function(response) {
            if (response.Success) {
                SIG.Alert('Alerta', 'Los datos se registraron correctamente.', redirectIndex, redirectIndex);
            } else {
                SIG.Alert('Alerta', response.Message, null);
            }
        });
    });

    function redirectIndex() {
        window.location.href = '@Url.Action("Almacenamiento", "ActaRecepcion", new { Area = "ActaRecepcion" })';
    }

    function validarNumero(value, colname) {
        if (!isNaN(value))
            return [true, "", ""];

        return [false, "El valor de \"" + colname + "\" debe ser un número", ""];
    }

    function cargarDetalleActa(numActa) {
        var opciones = {
            url: '@Url.Action("GetDetalleActa", "ActaRecepcion", new { area = "ActaRecepcion" })',
            parametros: { numActa: numActa }
        };

        SIG.Ajax(opciones, function (response) {
            if (response.Success) {
                var $grilla = $("#" + grdDetalle);
                var item;
                $grilla.jqGrid('clearGridData');

                for (var i = 0; i < response.Data.length; i++) {
                    item = response.Data[i];
                    item.Columna = "";
                    item.Fila = "";
                    $grilla.addRowData(item.Id, item);
                }
            }
        });
    }
</script>